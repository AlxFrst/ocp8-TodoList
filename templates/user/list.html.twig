{% extends 'base.html.twig' %}

{% block header_title %}
	<h1 class="mb-4">
		<i class="fas fa-users me-2"></i>Liste des utilisateurs
	</h1>
{% endblock %}

{% block body %}
	<div class="mb-4">
		<a href="{{ path('user_create') }}" class="btn btn-action">
			<i class="fas fa-user-plus me-2"></i>Créer un utilisateur
		</a>
	</div>

	<div class="mb-4">
		<input type="text" id="userSearch" class="form-control" placeholder="Rechercher un utilisateur...">
	</div>

	{% if users|length == 0 %}
		<div class="alert alert-warning" role="alert">
			<i class="fas fa-exclamation-triangle me-2"></i>Il n'y a pas encore d'utilisateur enregistré.
		</div>
	{% else %}
		<div id="userList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
			{% for user in users %}
				<div class="col user-col">
					<div class="card h-100 shadow-sm user-card" data-username="{{ user.username|lower }}">
						<div class="card-body">
							<h5 class="card-title">
								<i class="fas fa-user me-2"></i>
								{{ user.username }}
							</h5>
							<p class="card-text">
								<small class="text-muted">
									<i class="fas fa-envelope me-2"></i>
									{{ user.email }}
								</small>
							</p>
							<p class="card-text">
								<strong>Rôles :</strong><br>
								{% for role in user.roles %}
									{% if role == 'ROLE_ADMIN' %}
										<span class="badge bg-danger">Admin</span>
									{% elseif role == 'ROLE_USER' %}
										<span class="badge bg-primary">Utilisateur</span>
									{% endif %}
								{% endfor %}
							</p>
						</div>
						<div class="card-footer bg-transparent border-top-0">
							<a href="{{ path('user_edit', {'id' : user.id}) }}" class="btn btn-action">
								<i class="fas fa-edit me-2"></i>Éditer
							</a>
						</div>
					</div>
				</div>
			{% endfor %}
		</div>
	{% endif %}

	<script>
		console.log("Script de recherche chargé");

function filterUsers() {
const searchInput = document.getElementById('userSearch');
const userCols = document.querySelectorAll('.user-col');
const userList = document.getElementById('userList');

if (! searchInput || userCols.length === 0 || ! userList) {
console.error("Éléments nécessaires non trouvés");
return;
}

const searchTerm = searchInput.value.toLowerCase().trim();
let visibleCards = 0;

userCols.forEach(col => {
const card = col.querySelector('.user-card');
const username = card.dataset.username;
if (username.includes(searchTerm)) {
col.style.display = '';
visibleCards++;
} else {
col.style.display = 'none';
}
});

updateNoResultsMessage(visibleCards, userList);
}

function updateNoResultsMessage(visibleCards, userList) {
let noResults = document.getElementById('noResults');
if (visibleCards === 0) {
if (! noResults) {
noResults = document.createElement('div');
noResults.id = 'noResults';
noResults.className = 'alert alert-info col-12';
noResults.textContent = 'Aucun utilisateur trouvé.';
userList.appendChild(noResults);
}
} else if (noResults) {
noResults.remove();
}
}

// Attendre que le DOM soit complètement chargé
document.addEventListener('DOMContentLoaded', function () {
const searchInput = document.getElementById('userSearch');
if (searchInput) {
searchInput.addEventListener('input', filterUsers);
console.log("Écouteur d'événements ajouté à la barre de recherche");
} else {
console.error("Barre de recherche non trouvée");
}
});
	</script>
{% endblock %}
